<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LinkedIn Lead Intelligence</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f6fa; color: #2d3436; min-height: 100vh; }
  .container { max-width: 1100px; margin: 0 auto; padding: 24px; }

  /* === HEADER === */
  header { text-align: center; padding: 40px 0 28px; }
  .header-title { display: inline-flex; align-items: center; gap: 12px; }
  .li-icon { width: 36px; height: 36px; border-radius: 8px; background: #0077b5; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,119,181,0.35); }
  .li-icon svg { display: block; }
  header h1 { font-size: 1.75rem; font-weight: 800; letter-spacing: -0.5px; background: linear-gradient(90deg, #0077b5 0%, #00a0dc 30%, #0077b5 60%, #004182 85%, #0077b5 100%); background-size: 250% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: liGradient 4s linear infinite; }
  @keyframes liGradient { 0% { background-position: 0% center; } 100% { background-position: 250% center; } }
  header p { color: #636e72; font-size: 0.95rem; margin-top: 6px; }

  /* === FORM === */
  .search-form { background: #fff; border: 1px solid #e0e3ea; border-radius: 14px; padding: 24px 28px; margin-bottom: 28px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
  .form-required { display: grid; grid-template-columns: 1fr 1fr 120px; gap: 16px; align-items: end; }
  .form-actions { display: flex; justify-content: flex-end; margin-top: 16px; gap: 12px; align-items: center; }

  .field { display: flex; flex-direction: column; gap: 6px; }
  .field label { font-size: 0.7rem; color: #636e72; text-transform: uppercase; letter-spacing: 0.8px; font-weight: 600; }
  .field input, .field select { background: #f8f9fc; border: 1px solid #e0e3ea; border-radius: 8px; padding: 10px 14px; color: #2d3436; font-size: 0.9rem; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
  .field input:focus, .field select:focus { border-color: #4f6af6; box-shadow: 0 0 0 3px rgba(79,106,246,0.1); }
  .field input::placeholder { color: #b2bec3; }
  .field-hint { font-size: 0.65rem; color: #b2bec3; margin-top: 2px; }
  .field-full { grid-column: 1 / -1; }

  .btn-primary { background: #4f6af6; color: #fff; border: none; border-radius: 8px; padding: 10px 24px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: background 0.2s, transform 0.1s; white-space: nowrap; height: 42px; }
  .btn-primary:hover { background: #3d56d4; }
  .btn-primary:active { transform: scale(0.98); }
  .btn-primary:disabled { background: #b2bec3; cursor: not-allowed; }
  .btn-secondary { background: #fff; color: #4f6af6; border: 1px solid #4f6af6; border-radius: 8px; padding: 8px 18px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .btn-secondary:hover { background: #f0f4ff; }
  .btn-sm { padding: 6px 14px; font-size: 0.8rem; height: auto; }

  /* === ADVANCED FILTERS TOGGLE === */
  .adv-toggle { display: flex; align-items: center; gap: 6px; background: none; border: none; color: #4f6af6; cursor: pointer; font-size: 0.8rem; font-weight: 600; padding: 8px 0; margin-top: 12px; }
  .adv-toggle svg { transition: transform 0.2s; }
  .adv-toggle.open svg { transform: rotate(180deg); }
  .adv-section { display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f2f5; }
  .adv-section.visible { display: block; }
  .adv-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

  /* === TAG INPUT === */
  .tag-input-wrap { display: flex; flex-wrap: wrap; gap: 4px; padding: 6px 10px; border: 1px solid #e0e3ea; border-radius: 8px; background: #f8f9fc; min-height: 42px; cursor: text; transition: border-color 0.2s, box-shadow 0.2s; }
  .tag-input-wrap:focus-within { border-color: #4f6af6; box-shadow: 0 0 0 3px rgba(79,106,246,0.1); }
  .tag-chip { display: inline-flex; align-items: center; gap: 4px; background: #e8ecff; color: #4f6af6; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
  .tag-chip .rm { cursor: pointer; opacity: 0.6; font-size: 0.7rem; margin-left: 2px; }
  .tag-chip .rm:hover { opacity: 1; }
  .tag-input { border: none; outline: none; background: transparent; flex: 1; min-width: 80px; font-size: 0.85rem; padding: 4px 0; }

  /* === MULTI-SELECT DROPDOWN === */
  .ms-wrap { position: relative; }
  .ms-trigger { display: flex; align-items: center; justify-content: space-between; background: #f8f9fc; border: 1px solid #e0e3ea; border-radius: 8px; padding: 10px 14px; cursor: pointer; font-size: 0.85rem; color: #636e72; transition: border-color 0.2s; min-height: 42px; }
  .ms-trigger:hover { border-color: #4f6af6; }
  .ms-trigger .count { background: #4f6af6; color: #fff; font-size: 0.7rem; padding: 1px 7px; border-radius: 10px; margin-left: 8px; }
  .ms-dropdown { display: none; position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: #fff; border: 1px solid #e0e3ea; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 100; max-height: 260px; overflow-y: auto; }
  .ms-dropdown.open { display: block; }
  .ms-search { position: sticky; top: 0; padding: 8px; background: #fff; border-bottom: 1px solid #f0f2f5; }
  .ms-search input { width: 100%; padding: 8px 10px; border: 1px solid #e0e3ea; border-radius: 6px; font-size: 0.85rem; outline: none; }
  .ms-opt { display: flex; align-items: center; gap: 8px; padding: 8px 14px; cursor: pointer; font-size: 0.85rem; transition: background 0.1s; }
  .ms-opt:hover { background: #f0f4ff; }
  .ms-opt input[type="checkbox"] { accent-color: #4f6af6; }

  /* === TOGGLE SWITCH === */
  .toggle-wrap { display: flex; align-items: center; gap: 10px; }
  .toggle { position: relative; width: 44px; height: 24px; background: #dfe6e9; border-radius: 12px; cursor: pointer; transition: background 0.2s; }
  .toggle.on { background: #4f6af6; }
  .toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: left 0.2s; }
  .toggle.on::after { left: 22px; }

  /* === PIPELINE === */
  .pipeline { display: none; margin-bottom: 24px; }
  .pipeline.visible { display: block; }
  .pipeline-header { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
  .pipeline-step { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; color: #b2bec3; font-weight: 500; transition: color 0.3s; }
  .pipeline-step.active { color: #4f6af6; }
  .pipeline-step.done { color: #00b894; cursor: pointer; }
  .pipeline-step.done:hover { color: #00a381; }
  .pipeline-step.done:hover .step-dot { transform: scale(1.12); box-shadow: 0 2px 8px rgba(0,184,148,0.4); }
  .step-dot { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; font-weight: 700; background: #edf0f5; color: #b2bec3; transition: all 0.25s; }
  .pipeline-step.active .step-dot { background: #4f6af6; color: #fff; animation: pulse 1.5s infinite; }
  .pipeline-step.done .step-dot { background: #00b894; color: #fff; }
  .step-line { width: 24px; height: 2px; background: #edf0f5; }
  .step-line.done { background: #00b894; }
  @keyframes pulse { 0%,100% { box-shadow: 0 0 0 0 rgba(79,106,246,0.3); } 50% { box-shadow: 0 0 0 6px rgba(79,106,246,0); } }

  /* === STATUS AREA === */
  .status-area { background: #fff; border: 1px solid #e0e3ea; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; display: none; box-shadow: 0 1px 3px rgba(0,0,0,0.04); text-align: center; }
  .status-area.visible { display: block; }
  .status-main { font-size: 0.95rem; color: #2d3436; font-weight: 600; margin-bottom: 8px; }
  .status-sub { font-size: 0.8rem; color: #636e72; min-height: 20px; transition: opacity 0.3s; }
  .status-sub.fade { opacity: 0; }

  /* === FLOATING DEEP SEARCH BUTTON === */
  .floating-deep-search { position: fixed; bottom: 32px; right: 32px; z-index: 200; display: none; }
  .floating-deep-search.visible { display: block; animation: floatIn 0.4s cubic-bezier(0.34,1.56,0.64,1); }
  @keyframes floatIn { from { opacity: 0; transform: translateY(20px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
  .btn-float { background: linear-gradient(135deg, #00b894 0%, #00a381 100%); color: #fff; border: none; border-radius: 50px; padding: 16px 32px; font-size: 0.95rem; font-weight: 700; cursor: pointer; box-shadow: 0 8px 24px rgba(0,184,148,0.35), 0 0 0 0 rgba(0,184,148,0.4); transition: transform 0.2s, box-shadow 0.2s; animation: floatPulse 2.5s ease-in-out infinite; display: flex; align-items: center; gap: 10px; }
  .btn-float:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(0,184,148,0.45), 0 0 0 0 rgba(0,184,148,0); animation: none; }
  .btn-float:active { transform: translateY(-1px); }
  .btn-float:disabled { opacity: 0.6; cursor: not-allowed; animation: none; }
  @keyframes floatPulse { 0%, 100% { box-shadow: 0 8px 24px rgba(0,184,148,0.35), 0 0 0 0 rgba(0,184,148,0.4); } 50% { box-shadow: 0 8px 24px rgba(0,184,148,0.35), 0 0 0 10px rgba(0,184,148,0); } }

  /* === SCORING ANIMATION === */
  .scoring-stage { display: none; margin-bottom: 24px; }
  .scoring-stage.visible { display: block; }
  .scoring-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .scoring-title { font-size: 0.9rem; font-weight: 600; color: #2d3436; }
  .scoring-counter { font-size: 0.85rem; color: #636e72; font-weight: 500; }
  .scoring-track { background: #fff; border: 1px solid #e0e3ea; border-radius: 12px; padding: 16px 20px; min-height: 72px; overflow: hidden; position: relative; }
  .slide-card { display: flex; align-items: center; gap: 14px; }
  .slide-card.enter { animation: slideIn 0.6s ease-out forwards; }
  .slide-card.exit { animation: slideOut 0.6s ease-in forwards; }
  @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
  .slide-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 700; color: #fff; flex-shrink: 0; }
  .slide-info { flex: 1; min-width: 0; }
  .slide-name { font-size: 0.9rem; font-weight: 600; color: #2d3436; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .slide-detail { font-size: 0.75rem; color: #636e72; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .slide-score-area { text-align: center; min-width: 60px; }
  .slide-spinner { width: 20px; height: 20px; border: 2px solid #e0e3ea; border-top-color: #4f6af6; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .slide-score { font-size: 1.3rem; font-weight: 700; }
  .slide-score.warm { color: #00b894; }
  .slide-score.cold { color: #b2bec3; }
  .slide-label { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }

  /* === SELECTION INTERFACE === */
  .selection-section { display: none; margin-bottom: 24px; }
  .selection-section.visible { display: block; }
  .selection-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
  .selection-title { font-size: 1rem; font-weight: 600; color: #2d3436; }
  .selection-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .selection-count { font-size: 0.8rem; color: #636e72; background: #f0f2f5; padding: 4px 12px; border-radius: 20px; }
  .select-group { background: #fff; border: 1px solid #e0e3ea; border-radius: 12px; padding: 16px 20px; margin-bottom: 16px; }
  .select-group-title { font-size: 0.85rem; font-weight: 600; color: #2d3436; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .select-group-title .badge { background: #4f6af6; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }
  .select-group-title .badge.orange { background: #e17055; }
  .select-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f5f6fa; cursor: pointer; transition: background 0.1s; }
  .select-item:last-child { border-bottom: none; }
  .select-item:hover { background: #fafbff; margin: 0 -20px; padding-left: 20px; padding-right: 20px; }
  .select-item input[type="checkbox"] { accent-color: #4f6af6; width: 18px; height: 18px; flex-shrink: 0; }
  .select-item-info { flex: 1; min-width: 0; }
  .select-item-name { font-size: 0.9rem; font-weight: 600; color: #2d3436; }
  .select-item-detail { font-size: 0.75rem; color: #636e72; }
  .select-item-email { font-size: 0.75rem; color: #00b894; }

  /* === RESULT CARDS === */
  .results-section { display: none; }
  .results-section.visible { display: block; }
  .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px; }
  .results-title { font-size: 1.1rem; font-weight: 700; color: #1a1a2e; }

  /* === RESULT CARDS === */
  .result-card { background: #fff; border: 1px solid #e0e3ea; border-radius: 14px; padding: 0; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); animation: fadeUp 0.3s ease-out; overflow: visible; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Header row */
  .rc-head { display: flex; align-items: flex-start; gap: 14px; padding: 20px 20px 16px; }
  .rc-avatar { width: 46px; height: 46px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; font-weight: 700; color: #fff; flex-shrink: 0; margin-top: 2px; overflow: hidden; }
  .rc-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: block; }
  .rc-info { flex: 1; min-width: 0; }
  .result-name { font-size: 1.05rem; font-weight: 700; color: #1a1a2e; cursor: pointer; line-height: 1.25; }
  .result-name:hover { color: #4f6af6; text-decoration: underline; }
  .result-posts-hint { font-size: 0.68rem; color: #b2bec3; margin-top: 2px; }
  .rc-headline { font-size: 0.83rem; color: #4a5568; margin-top: 5px; line-height: 1.4; }
  .rc-location { font-size: 0.78rem; color: #b2bec3; margin-top: 3px; }
  .rc-stats { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; align-items: center; font-size: 0.72rem; color: #b2bec3; }
  .rc-stat-sep { color: #dfe6e9; }
  .rc-hiring { font-size: 0.65rem; font-weight: 700; background: #fde8e8; color: #e17055; padding: 2px 8px; border-radius: 8px; letter-spacing: 0.3px; }

  /* Score column */
  .rc-score-col { display: flex; flex-direction: column; align-items: center; gap: 5px; flex-shrink: 0; padding-left: 6px; }
  .rsb-label { display: flex; align-items: center; gap: 4px; font-size: 0.58rem; color: #b2bec3; text-transform: uppercase; letter-spacing: 0.7px; font-weight: 600; position: relative; }
  .rsb-label .tip-icon { width: 13px; height: 13px; border-radius: 50%; background: #e0e3ea; color: #636e72; font-size: 0.55rem; font-weight: 700; display: flex; align-items: center; justify-content: center; cursor: default; flex-shrink: 0; font-style: normal; }
  .rsb-label .tip-icon:hover .tooltip,
  .rsb-label .tip-icon:focus .tooltip { opacity: 1; pointer-events: auto; }
  .tooltip { position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: #1a1a2e; color: #fff; font-size: 0.72rem; line-height: 1.45; padding: 8px 12px; border-radius: 8px; width: 210px; white-space: normal; text-align: left; text-transform: none; letter-spacing: 0; font-weight: 400; opacity: 0; pointer-events: none; transition: opacity 0.15s; z-index: 50; box-shadow: 0 4px 14px rgba(0,0,0,0.2); }
  .tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 5px solid transparent; border-top-color: #1a1a2e; }
  .rc-score-ring { width: 62px; height: 62px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 800; }
  .rc-score-ring.high { background: #e8f8f5; color: #00b894; border: 2.5px solid #00b894; }
  .rc-score-ring.mid { background: #fef9e7; color: #f39c12; border: 2.5px solid #f39c12; }
  .rc-score-ring.low { background: #f5f6fa; color: #b2bec3; border: 2.5px solid #dfe6e9; }
  .result-activity { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.4px; padding: 2px 9px; border-radius: 10px; display: inline-block; }
  .result-activity.high { background: #e8f8f5; color: #00b894; }
  .result-activity.medium { background: #fef9e7; color: #f39c12; }
  .result-activity.low { background: #f5f6fa; color: #b2bec3; }
  .result-activity.inactive { background: #fde8e8; color: #e17055; }

  /* Divider */
  .rc-sep { height: 1px; background: #f0f2f5; }

  /* Contact row */
  .rc-contact { display: flex; gap: 10px; padding: 11px 20px; flex-wrap: wrap; align-items: center; }
  .rc-email-btn { display: inline-flex; align-items: center; gap: 6px; background: #f0f4ff; color: #4f6af6; border-radius: 8px; padding: 6px 12px; font-size: 0.78rem; font-weight: 600; cursor: pointer; border: 1px solid #d8e1ff; transition: background 0.15s; user-select: none; }
  .rc-email-btn:hover { background: #e0e8ff; }
  .rc-copy-hint { font-size: 0.68rem; color: #a0aec0; font-weight: 400; }
  .rc-linkedin-btn { display: inline-flex; align-items: center; gap: 5px; background: #f0f8ff; color: #0077b5; border-radius: 8px; padding: 6px 12px; font-size: 0.78rem; font-weight: 600; text-decoration: none; border: 1px solid #c8e6f7; transition: background 0.15s; }
  .rc-linkedin-btn:hover { background: #d8eef8; }

  /* Body */
  .rc-body { padding: 14px 20px 18px; }
  .rc-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 14px; }
  .chip { background: #f0f4ff; color: #4f6af6; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
  .chip.interest { background: #e8f8f5; color: #00b894; }
  .rc-insight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
  .rc-insight-box { background: #f8f9fc; border-radius: 8px; padding: 10px 12px; }
  .rc-insight-title { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: #b2bec3; margin-bottom: 5px; }
  .rc-insight-text { font-size: 0.78rem; color: #636e72; line-height: 1.52; }
  .rc-recommendation { background: #f8f9ff; border-left: 3px solid #4f6af6; border-radius: 0 8px 8px 0; padding: 10px 14px; font-size: 0.82rem; color: #2d3436; line-height: 1.55; }

  /* === PROFILE CHAT === */
  .rc-chat-btn { display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, #6c5ce7 0%, #a855f7 100%); color: #fff; border-radius: 8px; padding: 6px 13px; font-size: 0.78rem; font-weight: 700; cursor: pointer; border: none; box-shadow: 0 2px 10px rgba(108,92,231,0.35), 0 0 0 0 rgba(108,92,231,0.4); animation: chatPulse 2.4s ease-in-out infinite; transition: transform 0.15s, box-shadow 0.15s; letter-spacing: 0.2px; }
  .rc-chat-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(108,92,231,0.5), 0 0 0 0 rgba(108,92,231,0); animation: none; }
  .rc-chat-btn:active { transform: translateY(0); }
  .rc-chat-btn:disabled { opacity: 0.65; cursor: wait; animation: none; }
  @keyframes chatPulse { 0%, 100% { box-shadow: 0 2px 10px rgba(108,92,231,0.35), 0 0 0 0 rgba(108,92,231,0.4); } 50% { box-shadow: 0 2px 10px rgba(108,92,231,0.35), 0 0 0 7px rgba(108,92,231,0); } }
  .rc-outreach-btn { display: inline-flex; align-items: center; gap: 5px; background: #fff; color: #00b894; border: 1.5px solid #00b894; border-radius: 8px; padding: 6px 12px; font-size: 0.78rem; font-weight: 600; cursor: pointer; transition: background 0.15s, transform 0.1s; }
  .rc-outreach-btn:hover { background: #e8f8f5; transform: translateY(-1px); }
  .rc-outreach-btn:disabled { opacity: 0.6; cursor: wait; }
  .spin { animation: spin360 0.8s linear infinite; transform-origin: center; }
  @keyframes spin360 { to { transform: rotate(360deg); } }

  .chat-modal { display: none; position: fixed; inset: 0; z-index: 500; align-items: center; justify-content: center; }
  .chat-modal.open { display: flex; }
  .chat-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(3px); }
  .chat-panel { position: relative; background: #fff; border-radius: 18px; width: 500px; max-width: 95vw; height: 600px; max-height: 92vh; display: flex; flex-direction: column; box-shadow: 0 24px 60px rgba(0,0,0,0.2); animation: chatPop 0.22s cubic-bezier(0.34,1.56,0.64,1); }
  @keyframes chatPop { from { opacity: 0; transform: scale(0.93) translateY(12px); } to { opacity: 1; transform: scale(1) translateY(0); } }
  .chat-header { padding: 14px 18px; border-bottom: 1px solid #f0f2f5; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
  .chat-profile-info { display: flex; align-items: center; gap: 10px; }
  .chat-header-avatar { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.82rem; font-weight: 700; color: #fff; flex-shrink: 0; overflow: hidden; }
  .chat-header-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .chat-name { font-size: 0.92rem; font-weight: 700; color: #1a1a2e; }
  .chat-sub { font-size: 0.7rem; color: #b2bec3; margin-top: 1px; }
  .chat-close { background: none; border: none; font-size: 1.1rem; color: #b2bec3; cursor: pointer; padding: 6px 8px; border-radius: 6px; line-height: 1; }
  .chat-close:hover { color: #636e72; background: #f0f2f5; }
  .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 10px; }
  .chat-welcome { text-align: center; padding: 18px 10px 10px; }
  .chat-welcome-icon { font-size: 2.2rem; margin-bottom: 8px; }
  .chat-welcome-text { font-size: 0.82rem; color: #636e72; line-height: 1.55; }
  .chat-suggestions { margin-top: 16px; }
  .chat-sug-label { font-size: 0.62rem; color: #b2bec3; text-transform: uppercase; letter-spacing: 0.7px; font-weight: 600; margin-bottom: 8px; }
  .chat-sug-chips { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
  .sug-chip { background: #f0f4ff; color: #4f6af6; border: 1px solid #d8e1ff; border-radius: 20px; padding: 5px 12px; font-size: 0.75rem; cursor: pointer; transition: background 0.15s; }
  .sug-chip:hover { background: #e0e8ff; }
  .chat-msg { display: flex; flex-direction: column; max-width: 82%; }
  .chat-msg.user { align-self: flex-end; align-items: flex-end; }
  .chat-msg.assistant { align-self: flex-start; align-items: flex-start; }
  .chat-bubble { padding: 10px 14px; border-radius: 14px; font-size: 0.83rem; line-height: 1.55; word-break: break-word; }
  .chat-msg.user .chat-bubble { background: #4f6af6; color: #fff; border-radius: 14px 14px 4px 14px; }
  .chat-msg.assistant .chat-bubble { background: #f0f2f5; color: #2d3436; border-radius: 14px 14px 14px 4px; }
  .chat-typing-wrap { align-self: flex-start; }
  .chat-typing { display: flex; gap: 5px; padding: 12px 16px; background: #f0f2f5; border-radius: 14px 14px 14px 4px; }
  .typing-dot { width: 7px; height: 7px; border-radius: 50%; background: #b2bec3; animation: tdot 1.2s infinite; }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes tdot { 0%, 80%, 100% { transform: translateY(0); opacity: 0.5; } 40% { transform: translateY(-7px); opacity: 1; } }
  .chat-input-area { padding: 12px 14px; border-top: 1px solid #f0f2f5; display: flex; gap: 8px; flex-shrink: 0; align-items: flex-end; }
  .chat-input { flex: 1; border: 1px solid #e0e3ea; border-radius: 10px; padding: 10px 14px; font-size: 0.85rem; outline: none; font-family: inherit; resize: none; line-height: 1.4; max-height: 100px; }
  .chat-input:focus { border-color: #6c5ce7; box-shadow: 0 0 0 3px rgba(108,92,231,0.1); }
  .chat-send-btn { background: #6c5ce7; color: #fff; border: none; border-radius: 10px; padding: 10px 14px; cursor: pointer; transition: background 0.15s; flex-shrink: 0; height: 42px; }
  .chat-send-btn:hover { background: #5a4bd1; }
  .chat-send-btn:disabled { background: #b2bec3; cursor: not-allowed; }

  /* === ERROR === */
  .error-msg { display: none; background: #fde8e8; color: #e17055; padding: 14px 20px; border-radius: 10px; margin-bottom: 16px; font-size: 0.85rem; }
  .error-msg.visible { display: block; }

  /* === FOOTER === */
  .footer { margin-top: 60px; padding: 32px 0 24px; border-top: 1px solid #e0e3ea; display: flex; flex-direction: column; align-items: center; gap: 14px; text-align: center; }
  .footer-tagline { font-size: 0.8rem; color: #636e72; line-height: 1.6; max-width: 420px; }
  .footer-logo { height: 30px; width: auto; }
  .footer-copy { font-size: 0.7rem; color: #b2bec3; }
  .footer-copy strong { color: #636e72; font-weight: 600; }

  /* === POST PANEL === */
  .post-panel { position: fixed; inset: 0; z-index: 300; display: none; }
  .post-panel.open { display: block; }
  .pp-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.35); }
  .pp-inner { position: absolute; right: 0; top: 0; bottom: 0; width: 500px; max-width: 96vw; background: #fff; box-shadow: -6px 0 32px rgba(0,0,0,0.14); display: flex; flex-direction: column; animation: ppSlideIn 0.22s ease-out; }
  @keyframes ppSlideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
  .pp-header { display: flex; align-items: center; gap: 12px; padding: 18px 20px 14px; border-bottom: 1px solid #e0e3ea; flex-shrink: 0; }
  .pp-avatar { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 700; color: #fff; flex-shrink: 0; }
  .pp-info { flex: 1; min-width: 0; }
  .pp-name { font-size: 0.95rem; font-weight: 700; color: #1a1a2e; }
  .pp-headline { font-size: 0.75rem; color: #636e72; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 1px; }
  .pp-close { background: none; border: none; font-size: 1.5rem; color: #b2bec3; cursor: pointer; padding: 2px 8px; border-radius: 6px; line-height: 1; flex-shrink: 0; }
  .pp-close:hover { background: #f0f2f5; color: #636e72; }
  .pp-tabs { display: flex; border-bottom: 1px solid #e0e3ea; flex-shrink: 0; }
  .pp-tab { flex: 1; background: none; border: none; border-bottom: 2px solid transparent; padding: 11px 14px; font-size: 0.82rem; font-weight: 600; color: #636e72; cursor: pointer; transition: all 0.15s; }
  .pp-tab.active { color: #4f6af6; border-bottom-color: #4f6af6; }
  .pp-tab:hover:not(.active) { background: #f8f9fc; }
  .pp-body { flex: 1; overflow-y: auto; padding: 14px 16px; }
  .pp-empty { text-align: center; padding: 40px 20px; color: #b2bec3; font-size: 0.85rem; }
  .post-card { background: #fff; border: 1px solid #e0e3ea; border-radius: 10px; overflow: visible; margin-bottom: 12px; transition: box-shadow 0.15s; }
  .post-card:hover { box-shadow: 0 3px 12px rgba(0,0,0,0.08); }
  .pc-thumb-wrap { position: relative; height: 160px; background: #edf0f5; overflow: hidden; border-radius: 10px 10px 0 0; }
  .pc-thumb { width: 100%; height: 100%; object-fit: cover; display: block; }
  .pc-overlay-badge { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.55); color: #fff; font-size: 0.62rem; font-weight: 700; padding: 2px 8px; border-radius: 4px; letter-spacing: 0.5px; }
  .pc-img-count { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.5); color: #fff; font-size: 0.62rem; padding: 2px 7px; border-radius: 4px; }
  .pc-placeholder { height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; background: #f0f2f5; border-bottom: 1px solid #e0e3ea; border-radius: 10px 10px 0 0; }
  .pc-placeholder-icon { font-size: 1.8rem; line-height: 1; }
  .pc-placeholder-label { font-size: 0.68rem; font-weight: 600; color: #b2bec3; text-transform: uppercase; letter-spacing: 0.6px; }
  .pc-doc-banner { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: #f0f4ff; border-bottom: 1px solid #dde5ff; }
  .pc-doc-icon { font-size: 1.4rem; line-height: 1; }
  .pc-doc-text { font-size: 0.75rem; font-weight: 600; color: #4f6af6; }
  .pc-body { padding: 11px 14px 12px; }
  .pc-score { display: inline-block; position: relative; background: #4f6af6; color: #fff; font-size: 0.62rem; font-weight: 700; padding: 1px 8px; border-radius: 10px; margin-bottom: 6px; cursor: default; }
  .pc-score:hover .tooltip { opacity: 1; pointer-events: auto; }
  .pc-text { font-size: 0.8rem; color: #2d3436; line-height: 1.55; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
  .pc-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 9px; flex-wrap: wrap; gap: 6px; }
  .pc-date { font-size: 0.7rem; color: #b2bec3; }
  .pc-stats { display: flex; gap: 10px; font-size: 0.7rem; color: #636e72; }
  .pc-link { font-size: 0.7rem; color: #4f6af6; text-decoration: none; font-weight: 600; }
  .pc-link:hover { text-decoration: underline; }
  /* === RESPONSIVE === */
  @media (max-width: 800px) {
    .form-required { grid-template-columns: 1fr; }
    .adv-grid { grid-template-columns: 1fr; }
    .result-top { flex-direction: column; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-title">
      <div class="li-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="white"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6zM2 9h4v12H2zm2-3a2 2 0 100-4 2 2 0 000 4z"/></svg>
      </div>
      <h1>LinkedIn Lead Intelligence</h1>
    </div>
    <p>Find, filter, and analyze the right prospects</p>
  </header>

  <!-- SEARCH FORM -->
  <div class="search-form" id="searchForm">
    <div class="form-required">
      <div class="field field-full">
        <label>Search Query <span style="color:#e17055">*</span></label>
        <input type="text" id="searchQuery" placeholder='e.g. Brand Managers, Marketing Directors, Sales Head'>
      </div>
      <div class="field">
        <label>Locations</label>
        <div class="tag-input-wrap" id="locationsWrap"><input class="tag-input" data-field="locations" placeholder="Type & press Enter"></div>
      </div>
      <div class="field">
        <label>Industry</label>
        <div class="ms-wrap" id="msIndustry"></div>
      </div>
      <div class="field">
        <label>Max Profiles</label>
        <input type="number" id="maxItems" value="50" min="50" max="500">
      </div>
    </div>

    <button class="adv-toggle" id="advToggle" onclick="toggleAdvanced()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
      Advanced Filters
    </button>

    <div class="adv-section" id="advSection">
      <div class="adv-grid">
        <!-- Tag inputs (left-ish) -->
        <div class="field"><label>Current Job Titles</label><div class="tag-input-wrap" id="currentJobTitlesWrap"><input class="tag-input" data-field="currentJobTitles" placeholder="Type & press Enter"></div></div>
        <div class="field"><label>Current Companies</label><div class="tag-input-wrap" id="currentCompaniesWrap"><input class="tag-input" data-field="currentCompanies" placeholder="Type & press Enter"></div></div>
        <div class="field"><label>Past Job Titles</label><div class="tag-input-wrap" id="pastJobTitlesWrap"><input class="tag-input" data-field="pastJobTitles" placeholder="Type & press Enter"></div></div>
        <div class="field"><label>Past Companies</label><div class="tag-input-wrap" id="pastCompaniesWrap"><input class="tag-input" data-field="pastCompanies" placeholder="Type & press Enter"></div></div>
        <div class="field"><label>Schools</label><div class="tag-input-wrap" id="schoolsWrap"><input class="tag-input" data-field="schools" placeholder="Type & press Enter"></div></div>
        <div class="field"><label>First Names</label><div class="tag-input-wrap" id="firstNamesWrap"><input class="tag-input" data-field="firstNames" placeholder="Type & press Enter"></div></div>
        <div class="field"><label>Last Names</label><div class="tag-input-wrap" id="lastNamesWrap"><input class="tag-input" data-field="lastNames" placeholder="Type & press Enter"></div></div>

        <!-- Multi-selects (right-ish) -->
        <div class="field"><label>Seniority Level</label><div class="ms-wrap" id="msSeniority"></div></div>
        <div class="field"><label>Job Function</label><div class="ms-wrap" id="msFunction"></div></div>
        <div class="field"><label>Years of Experience</label><div class="ms-wrap" id="msYearsExp"></div></div>
        <div class="field"><label>Years at Current Company</label><div class="ms-wrap" id="msYearsCompany"></div></div>
        <div class="field"><label>Company Size</label><div class="ms-wrap" id="msHeadcount"></div></div>
        <div class="field"><label>Profile Language</label><div class="ms-wrap" id="msLanguage"></div></div>
        <div class="field">
          <label>Recently Changed Jobs</label>
          <div class="toggle-wrap">
            <div class="toggle" id="toggleRecentJob" onclick="this.classList.toggle('on')"></div>
            <span style="font-size:0.8rem;color:#636e72">Only show people who recently changed jobs</span>
          </div>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button class="btn-primary" id="searchBtn" onclick="startSearch()">Search</button>
    </div>
  </div>

  <!-- PIPELINE -->
  <div class="pipeline" id="pipeline">
    <div class="pipeline-header">
      <div class="pipeline-step" id="ps1" onclick="onStepClick(1)"><div class="step-dot">1</div> Search</div>
      <div class="step-line" id="sl1"></div>
      <div class="pipeline-step" id="ps2" onclick="onStepClick(2)"><div class="step-dot">2</div> Filter</div>
      <div class="step-line" id="sl2"></div>
      <div class="pipeline-step" id="ps3" onclick="onStepClick(3)"><div class="step-dot">3</div> Select</div>
      <div class="step-line" id="sl3"></div>
      <div class="pipeline-step" id="ps4" onclick="onStepClick(4)"><div class="step-dot">4</div> Posts</div>
      <div class="step-line" id="sl4"></div>
      <div class="pipeline-step" id="ps5" onclick="onStepClick(5)"><div class="step-dot">5</div> Analyze</div>
      <div class="step-line" id="sl5"></div>
      <div class="pipeline-step" id="ps6" onclick="onStepClick(6)"><div class="step-dot">6</div> Results</div>
    </div>
  </div>

  <!-- STATUS -->
  <div class="status-area" id="statusArea">
    <div class="status-main" id="statusMain">Working...</div>
    <div class="status-sub" id="statusSub"></div>
  </div>

  <!-- ERROR -->
  <div class="error-msg" id="errorMsg"></div>

  <!-- SCORING ANIMATION -->
  <div class="scoring-stage" id="scoringStage">
    <div class="scoring-header">
      <div class="scoring-title" id="scoringTitle">Analyzing</div>
      <div class="scoring-counter" id="scoringCounter">0 / 0</div>
    </div>
    <div class="scoring-track" id="scoringTrack"></div>
  </div>

  <!-- SELECTION INTERFACE -->
  <div class="selection-section" id="selectionSection">
    <div class="selection-header">
      <div class="selection-title">Select profiles to analyze</div>
      <div class="selection-actions">
        <span class="selection-count" id="selectedCount">0 selected</span>
        <button class="btn-secondary btn-sm" onclick="toggleSelectAll()">Select All</button>
        <button class="btn-secondary btn-sm" onclick="exportCSV('with-email')">Export With Email</button>
        <button class="btn-secondary btn-sm" onclick="exportCSV('without-email')">Export Without Email</button>
      </div>
    </div>

    <div class="select-group" id="emailGroup">
      <div class="select-group-title">Profiles With Email <span class="badge" id="emailBadge">0</span></div>
      <div id="emailList"></div>
    </div>

    <div class="select-group" id="noEmailGroup">
      <div class="select-group-title">Profiles Without Email <span class="badge orange" id="noEmailBadge">0</span></div>
      <div id="noEmailList"></div>
    </div>
  </div>

  <!-- FLOATING DEEP SEARCH BUTTON -->
  <div class="floating-deep-search" id="floatingDeepSearch">
    <button class="btn-float" id="deepSearchBtn" onclick="startPostScraping()" disabled>
      <span>ðŸš€</span>
      <span id="deepSearchBtnText">Deep Search (0)</span>
    </button>
  </div>

  <!-- FINAL RESULTS -->
  <div class="results-section" id="resultsSection">
    <div class="results-header">
      <div class="results-title" id="resultsTitle">Analysis Results</div>
      <button class="btn-secondary btn-sm" onclick="exportCSV('analyzed')">Export Full Analysis CSV</button>
    </div>
    <div id="resultsList"></div>
  </div>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-tagline">AI-powered lead intelligence platform by <strong>Momentro</strong>. Find, score, and connect with the right prospects.</div>
    <img src="/static/logo.png" alt="Momentro" class="footer-logo">
    <div class="footer-copy">&copy; 2026 <strong>Momentro</strong>. All rights reserved.</div>
  </footer>
</div>

<!-- PROFILE CHAT MODAL -->
<div class="chat-modal" id="chatModal">
  <div class="chat-backdrop" onclick="closeChat()"></div>
  <div class="chat-panel">
    <div class="chat-header">
      <div class="chat-profile-info">
        <div class="chat-header-avatar" id="chatHeaderAvatar"></div>
        <div>
          <div class="chat-name" id="chatHeaderName"></div>
          <div class="chat-sub">Ask anything about this profile</div>
        </div>
      </div>
      <button class="chat-close" onclick="closeChat()">&#10005;</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
      <textarea class="chat-input" id="chatInput" rows="1" placeholder="Ask anything about this person..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChatMessage();}"></textarea>
      <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- POST PANEL OVERLAY -->
<div class="post-panel" id="postPanel">
  <div class="pp-backdrop" onclick="closePostPanel()"></div>
  <div class="pp-inner">
    <div class="pp-header">
      <div class="pp-avatar" id="ppAvatar"></div>
      <div class="pp-info">
        <div class="pp-name" id="ppName"></div>
        <div class="pp-headline" id="ppHeadline"></div>
      </div>
      <button class="pp-close" onclick="closePostPanel()">&#x2715;</button>
    </div>
    <div class="pp-tabs">
      <button class="pp-tab active" id="ppTabRelevant" onclick="switchPPTab('relevant')">Most Relevant</button>
      <button class="pp-tab" id="ppTabRecent" onclick="switchPPTab('recent')">Recent Posts (max :10)</button>
    </div>
    <div class="pp-body" id="ppBody"></div>
  </div>
</div>

<script>
  // â”€â”€â”€ GLOBALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let jobId = null;
  let pollTimer = null;
  let filterOptions = {};
  let industries = [];
  const tagData = {};
  const msData = {};
  const AVATAR_COLORS = ['#4f6af6','#00b894','#e17055','#6c5ce7','#00cec9','#fdcb6e','#a29bfe','#fd79a8','#55efc4','#74b9ff'];
  const SCRAPING_MESSAGES = [
    "Scanning LinkedIn's network for matching profiles...",
    "Digging through thousands of professional profiles...",
    "Exploring LinkedIn's network as we speak...",
    "Matching keywords against millions of profiles...",
    "Cross-referencing job titles and industries...",
    "Checking company pages for decision-makers...",
    "Hunting for the perfect leads just for you...",
    "Sifting through the noise to find the gold...",
    "Reading between the lines of LinkedIn bios...",
    "Almost there... quality takes a moment...",
    "Mapping the professional landscape...",
    "Identifying key decision-makers in your niche...",
    "Building your lead pipeline from scratch...",
  ];
  const POST_MESSAGES = [
    "Reading through their LinkedIn feed...",
    "Collecting posts and engagement data...",
    "Gathering content activity and insights...",
    "Checking what they've been sharing recently...",
    "Analyzing their posting patterns...",
  ];
  let msgInterval = null;
  let dotInterval = null;

  // â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (async function init() {
    const [fRes, iRes] = await Promise.all([
      fetch('/static/data/filter_options.json'),
      fetch('/static/data/industries.json'),
    ]);
    filterOptions = await fRes.json();
    industries = await iRes.json();

    // Build multi-selects
    buildMultiSelect('msSeniority', filterOptions.seniorityLevels, 'seniorityLevelIds');
    buildMultiSelect('msFunction', filterOptions.functions, 'functionIds');
    buildMultiSelect('msYearsExp', filterOptions.yearsOfExperience, 'yearsOfExperienceIds');
    buildMultiSelect('msYearsCompany', filterOptions.yearsAtCurrentCompany, 'yearsAtCurrentCompanyIds');
    buildMultiSelect('msHeadcount', filterOptions.companyHeadcount, 'companyHeadcount');
    buildMultiSelectStrings('msLanguage', filterOptions.profileLanguages, 'profileLanguages');
    buildMultiSelect('msIndustry', industries.map(i => ({id: i.id, label: i.name})), 'industryIds', true);

    // Init tag inputs
    document.querySelectorAll('.tag-input').forEach(input => {
      const field = input.dataset.field;
      tagData[field] = [];
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault();
          const val = input.value.trim().replace(/,$/,'');
          if (val) { addTag(field, val, input); input.value = ''; }
        }
        if (e.key === 'Backspace' && !input.value && tagData[field].length) {
          removeTag(field, tagData[field].length - 1, input.parentElement);
        }
      });
      input.parentElement.addEventListener('click', () => input.focus());
    });

    // Live form validation â€” drives Search button enabled state
    document.getElementById('searchQuery').addEventListener('input', validateForm);
    document.getElementById('maxItems').addEventListener('input', validateForm);
    document.getElementById('maxItems').addEventListener('blur', validateForm);
    validateForm(); // set initial state

    // Close dropdowns on outside click
    document.addEventListener('click', (e) => {
      document.querySelectorAll('.ms-dropdown.open').forEach(dd => {
        if (!dd.parentElement.contains(e.target)) dd.classList.remove('open');
      });
    });
  })();

  // â”€â”€â”€ TAG INPUT FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addTag(field, value, input) {
    tagData[field].push(value);
    const chip = document.createElement('span');
    chip.className = 'tag-chip';
    chip.innerHTML = `${esc(value)}<span class="rm" onclick="removeTag('${field}',${tagData[field].length-1},this.closest('.tag-input-wrap'))">&times;</span>`;
    input.parentElement.insertBefore(chip, input);
  }
  function removeTag(field, idx, wrap) {
    tagData[field].splice(idx, 1);
    renderTags(field, wrap);
  }
  function renderTags(field, wrap) {
    const input = wrap.querySelector('.tag-input');
    wrap.querySelectorAll('.tag-chip').forEach(c => c.remove());
    tagData[field].forEach((val, i) => {
      const chip = document.createElement('span');
      chip.className = 'tag-chip';
      chip.innerHTML = `${esc(val)}<span class="rm" onclick="removeTag('${field}',${i},this.closest('.tag-input-wrap'))">&times;</span>`;
      wrap.insertBefore(chip, input);
    });
  }

  // â”€â”€â”€ MULTI-SELECT FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildMultiSelect(containerId, options, dataKey, searchable = false) {
    const container = document.getElementById(containerId);
    msData[dataKey] = [];

    container.innerHTML = `
      <div class="ms-trigger" onclick="this.nextElementSibling.classList.toggle('open');event.stopPropagation()">
        <span class="ms-placeholder">Select...</span>
      </div>
      <div class="ms-dropdown" onclick="event.stopPropagation()">
        ${searchable ? '<div class="ms-search"><input type="text" placeholder="Search..." oninput="filterMsOptions(this)"></div>' : ''}
        ${options.map(o => `
          <label class="ms-opt" data-label="${esc(o.label).toLowerCase()}">
            <input type="checkbox" value="${o.id}" onchange="toggleMsOption('${dataKey}','${o.id}','${containerId}')">
            ${esc(o.label)}
          </label>
        `).join('')}
      </div>
    `;
  }
  function buildMultiSelectStrings(containerId, options, dataKey) {
    const container = document.getElementById(containerId);
    msData[dataKey] = [];
    container.innerHTML = `
      <div class="ms-trigger" onclick="this.nextElementSibling.classList.toggle('open');event.stopPropagation()">
        <span class="ms-placeholder">Select...</span>
      </div>
      <div class="ms-dropdown" onclick="event.stopPropagation()">
        ${options.map(o => `
          <label class="ms-opt">
            <input type="checkbox" value="${o}" onchange="toggleMsOption('${dataKey}','${o}','${containerId}')">
            ${esc(o)}
          </label>
        `).join('')}
      </div>
    `;
  }
  function toggleMsOption(dataKey, value, containerId) {
    const arr = msData[dataKey];
    const idx = arr.indexOf(value);
    if (idx >= 0) arr.splice(idx, 1); else arr.push(value);
    const trigger = document.querySelector(`#${containerId} .ms-trigger`);
    if (arr.length) {
      trigger.innerHTML = `<span>Selected</span><span class="count">${arr.length}</span>`;
    } else {
      trigger.innerHTML = '<span class="ms-placeholder">Select...</span>';
    }
  }
  function filterMsOptions(input) {
    const q = input.value.toLowerCase();
    const dropdown = input.closest('.ms-dropdown');
    dropdown.querySelectorAll('.ms-opt').forEach(opt => {
      const label = opt.dataset.label || opt.textContent.toLowerCase();
      opt.style.display = label.includes(q) ? '' : 'none';
    });
  }

  // â”€â”€â”€ FORM HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleAdvanced() {
    const section = document.getElementById('advSection');
    const toggle = document.getElementById('advToggle');
    section.classList.toggle('visible');
    toggle.classList.toggle('open');
  }

  function gatherFormData() {
    // Flush any uncommitted tag input text (typed but Enter not pressed)
    document.querySelectorAll('.tag-input').forEach(input => {
      const field = input.dataset.field;
      const val = input.value.trim().replace(/,$/, '');
      if (val && tagData[field] !== undefined && !tagData[field].includes(val)) {
        tagData[field].push(val);
        input.value = '';
        renderTags(field, input.parentElement);
      }
    });

    const data = {
      searchQuery: document.getElementById('searchQuery').value.trim(),
      maxItems: parseInt(document.getElementById('maxItems').value) || 50,
    };
    // Tag fields
    for (const [key, vals] of Object.entries(tagData)) {
      if (vals.length) data[key] = vals;
    }
    // Multi-select fields
    for (const [key, vals] of Object.entries(msData)) {
      if (vals.length) data[key] = vals;
    }
    // Toggle
    if (document.getElementById('toggleRecentJob').classList.contains('on')) {
      data.recentlyChangedJobs = true;
    }
    return data;
  }

  // â”€â”€â”€ PIPELINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setPipeline(step, allDone) {
    for (let i = 1; i <= 6; i++) {
      const ps = document.getElementById('ps' + i);
      ps.classList.remove('active', 'done');
      if (allDone || i < step) ps.classList.add('done');
      else if (i === step) ps.classList.add('active');
    }
    for (let i = 1; i <= 5; i++) {
      const sl = document.getElementById('sl' + i);
      sl.classList.toggle('done', allDone || i < step);
    }
  }

  // â”€â”€â”€ STATUS AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showStatus(main, sub) {
    document.getElementById('statusArea').classList.add('visible');
    document.getElementById('statusMain').textContent = main;
    if (sub !== undefined) document.getElementById('statusSub').textContent = sub;
  }
  function hideStatus() { document.getElementById('statusArea').classList.remove('visible'); stopMessages(); }
  function startMessages(messages) {
    stopMessages();
    let idx = 0;
    const sub = document.getElementById('statusSub');
    msgInterval = setInterval(() => {
      sub.classList.add('fade');
      setTimeout(() => { idx = (idx + 1) % messages.length; sub.textContent = messages[idx]; sub.classList.remove('fade'); }, 300);
    }, 3000);
  }
  function stopMessages() { if (msgInterval) { clearInterval(msgInterval); msgInterval = null; } }

  // â”€â”€â”€ SLIDE ANIMATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getInitials(name) { return (name || '?').split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2); }
  function showSlideCard(profile, index) {
    const track = document.getElementById('scoringTrack');
    track.innerHTML = '';
    const card = document.createElement('div');
    card.className = 'slide-card enter';
    card.id = 'currentSlide';
    const color = AVATAR_COLORS[index % AVATAR_COLORS.length];
    card.innerHTML = `
      <div class="slide-avatar" style="background:${color}">${getInitials(profile.name)}</div>
      <div class="slide-info"><div class="slide-name">${esc(profile.name||'Unknown')}</div><div class="slide-detail">${esc(profile.headline||profile.company||'')}</div></div>
      <div class="slide-score-area" id="slideScoreArea"><div class="slide-spinner"></div><div class="slide-label">Analyzing</div></div>
    `;
    track.appendChild(card);
    setTimeout(() => { card.classList.remove('enter'); }, 600);
  }
  function updateSlideScore(score) {
    const area = document.getElementById('slideScoreArea');
    if (!area) return;
    const warm = score >= 60;
    area.innerHTML = `<div class="slide-score ${warm?'warm':'cold'}">${score}</div><div class="slide-label">${warm?'Strong Match':'Low Match'}</div>`;
  }
  function slideOut() {
    return new Promise(resolve => {
      const card = document.getElementById('currentSlide');
      if (!card) { resolve(); return; }
      card.classList.add('exit');
      setTimeout(resolve, 600);
    });
  }

  // â”€â”€â”€ FORM VALIDATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function validateForm() {
    const maxInput = document.getElementById('maxItems');
    const maxVal = parseInt(maxInput.value, 10);
    const maxOk = !isNaN(maxVal) && maxVal >= 50;
    const queryOk = document.getElementById('searchQuery').value.trim().length > 0;

    // maxItems visual feedback
    if (!maxOk) {
      maxInput.style.borderColor = '#e17055';
      maxInput.style.boxShadow = '0 0 0 3px rgba(225,112,85,0.15)';
    } else {
      maxInput.style.borderColor = '';
      maxInput.style.boxShadow = '';
    }

    document.getElementById('searchBtn').disabled = !(queryOk && maxOk);
  }

  // â”€â”€â”€ MAIN SEARCH FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function startSearch() {
    const data = gatherFormData();
    if (!data.searchQuery || data.maxItems < 50) return; // guard (button should already be disabled)

    const btn = document.getElementById('searchBtn');
    btn.disabled = true; btn.textContent = 'Searching...';

    // Reset UI
    document.getElementById('pipeline').classList.add('visible');
    document.getElementById('selectionSection').classList.remove('visible');
    document.getElementById('resultsSection').classList.remove('visible');
    document.getElementById('scoringStage').classList.remove('visible');
    document.getElementById('errorMsg').classList.remove('visible');
    setPipeline(1);

    showStatus('Searching LinkedIn for matching profiles...', SCRAPING_MESSAGES[0]);
    startMessages(SCRAPING_MESSAGES);

    try {
      const res = await fetch('/api/search/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data),
      });
      const result = await res.json();
      jobId = result.job_id;
      // Persist immediately so a browser refresh can reconnect to this job
      localStorage.setItem('leadIntelJobId', jobId);
      localStorage.setItem('leadIntelSearchQuery', data.searchQuery);
    } catch (e) {
      hideStatus(); showError('Failed to start search. Please try again.');
      btn.disabled = false; btn.textContent = 'Search';
      return;
    }

    // Start polling
    startPolling();
  }

  function startPolling() {
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(async () => {
      try {
        const res = await fetch(`/api/search/progress/${jobId}`);
        const job = await res.json();
        handleJobUpdate(job);
      } catch (e) { console.warn('Poll error:', e); }
    }, 1500);
  }

  let lastPhase = '';
  let lastAnalyzedCount = 0;
  let animQueue = [];
  let isAnimating = false;
  let animationCounter = 0; // Track animation progress separately
  let currentJobPhase = ''; // Track current job state
  let selectionData = {with_email: [], without_email: []}; // populated at awaiting_selection

  // â”€â”€â”€ PIPELINE STEP NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function onStepClick(step) {
    const el = document.getElementById('ps' + step);
    if (!el.classList.contains('done')) return; // only navigate to completed steps

    // Load selection data from memory or localStorage cache
    function getSelectionData() {
      if (selectionData.with_email.length || selectionData.without_email.length) return selectionData;
      try {
        const raw = localStorage.getItem('leadIntelSelectionData');
        if (raw) return JSON.parse(raw);
      } catch(e) {}
      return {with_email: [], without_email: []};
    }

    const sel = document.getElementById('selectionSection');
    const res = document.getElementById('resultsSection');
    const searchBtn = document.getElementById('searchBtn');
    const floatingBtn = document.getElementById('floatingDeepSearch');
    const scoring = document.getElementById('scoringStage');

    if (step <= 3) {
      // Steps 1-3: show the filtered profiles / selection view
      const sd = getSelectionData();
      if (sd.with_email.length || sd.without_email.length) {
        res.classList.remove('visible');
        scoring.classList.remove('visible');
        renderSelection(sd.with_email, sd.without_email);
        sel.scrollIntoView({behavior: 'smooth', block: 'start'});

        // Show search button always when navigating back
        searchBtn.style.display = '';

        // Only show floating button if job is still in awaiting_selection phase
        // If job is complete/error, user must start a new search to run Phase 2 again
        if (currentJobPhase === 'awaiting_selection') {
          floatingBtn.classList.add('visible');
        } else {
          floatingBtn.classList.remove('visible');
        }
      }
    } else {
      // Steps 4-6: show the final results
      if (analyzedProfiles.length > 0) {
        sel.classList.remove('visible');
        scoring.classList.remove('visible');
        res.classList.add('visible');
        res.scrollIntoView({behavior: 'smooth', block: 'start'});

        // Hide floating button in results view
        floatingBtn.classList.remove('visible');
        searchBtn.style.display = '';
      }
    }
  }

  function handleJobUpdate(job) {
    const btn = document.getElementById('searchBtn');

    if (job.phase === 'error') {
      clearInterval(pollTimer); pollTimer = null;
      localStorage.removeItem('leadIntelJobId');
      hideStatus(); showError(job.error);
      btn.style.display = '';
      btn.disabled = false;
      btn.textContent = 'Search';
      document.getElementById('floatingDeepSearch').classList.remove('visible');
      return;
    }

    if (job.phase === 'scraping') {
      if (lastPhase !== 'scraping') setPipeline(1);
      // Show live download counter once actor finishes and we're pulling dataset
      if (job.scrape_status === 'downloading' && job.profiles_found > 0) {
        document.getElementById('statusMain').textContent =
          `Downloading profiles: ${job.profiles_found} so far...`;
      }
    }

    if (job.phase === 'filtering' && lastPhase !== 'filtering') {
      stopMessages();
      showStatus(`Found ${job.profiles_found} profiles. Applying filters...`, '');
      setPipeline(2);
    }

    if (job.phase === 'awaiting_selection') {
      clearInterval(pollTimer); pollTimer = null;
      hideStatus();
      setPipeline(3);
      // Cache selection data so step-click navigation works after refresh
      selectionData = {with_email: job.profiles_with_email || [], without_email: job.profiles_without_email || []};
      try { localStorage.setItem('leadIntelSelectionData', JSON.stringify(selectionData)); } catch(e) {}
      renderSelection(job.profiles_with_email, job.profiles_without_email);

      // Hide search button, show floating Deep Search button
      btn.style.display = 'none';
      document.getElementById('floatingDeepSearch').classList.add('visible');

      return;
    }

    if (job.phase === 'scraping_posts') {
      if (lastPhase !== 'scraping_posts') {
        stopMessages();
        setPipeline(4);
        showStatus(`Scraping posts: ${job.posts_scraped} / ${job.posts_total}`, POST_MESSAGES[0]);
        startMessages(POST_MESSAGES);

        // Hide floating button and selection section when deep search starts
        document.getElementById('floatingDeepSearch').classList.remove('visible');
        document.getElementById('selectionSection').classList.remove('visible');
      } else {
        document.getElementById('statusMain').textContent = `Scraping posts: ${job.posts_scraped} / ${job.posts_total}` + (job.current_profile_name ? ` â€” ${job.current_profile_name}` : '');
      }
    }

    if (job.phase === 'analyzing') {
      if (lastPhase !== 'analyzing') {
        stopMessages();
        setPipeline(5);
        document.getElementById('scoringStage').classList.add('visible');
        document.getElementById('scoringTitle').textContent = 'Analyzing Profiles';
        animationCounter = 0; // Reset animation counter
        document.getElementById('scoringCounter').textContent = `0 / ${job.analyzed_total}`;
        showStatus('Analyzing profiles with AI...', 'Building comprehensive insights for each profile');
      }
      // Queue new analyzed profiles for animation
      if (job.analyzed_profiles && job.analyzed_profiles.length > lastAnalyzedCount) {
        const newProfiles = job.analyzed_profiles.slice(lastAnalyzedCount);
        for (const p of newProfiles) animQueue.push(p);
        lastAnalyzedCount = job.analyzed_profiles.length;
        processAnimQueue(job.analyzed_total);
      }
    }

    if (job.phase === 'complete') {
      clearInterval(pollTimer); pollTimer = null;
      // Wait for animation to finish
      const waitAnim = () => new Promise(resolve => {
        const check = () => (animQueue.length === 0 && !isAnimating) ? resolve() : setTimeout(check, 200);
        check();
      });
      waitAnim().then(() => {
        localStorage.removeItem('leadIntelJobId');
        hideStatus();
        document.getElementById('scoringStage').classList.remove('visible');
        setPipeline(6, true);
        renderResults(job.analyzed_profiles);

        // Cache to localStorage.
        // Trim posts to 30 per profile to stay within the ~5MB localStorage limit
        // while still giving the AI enough context after a browser refresh.
        const toCache = job.analyzed_profiles.map(p => ({
          ...p,
          posts: (p.posts || []).slice(0, 30),
        }));
        try {
          localStorage.setItem('leadIntelCache', JSON.stringify({
            analyzed: toCache,
            searchQuery: document.getElementById('searchQuery').value.trim(),
            timestamp: Date.now(),
            jobId: jobId,
          }));
        } catch (e) {
          // QuotaExceededError â€” try without posts as a last resort
          try {
            const minimal = job.analyzed_profiles.map(p => ({...p, posts: []}));
            localStorage.setItem('leadIntelCache', JSON.stringify({
              analyzed: minimal,
              searchQuery: document.getElementById('searchQuery').value.trim(),
              timestamp: Date.now(),
              jobId: jobId,
            }));
          } catch (_) { /* storage unavailable â€” results won't persist across refresh */ }
        }

        // Restore search button, hide floating button
        btn.style.display = '';
        btn.disabled = false;
        btn.textContent = 'Search';
        document.getElementById('floatingDeepSearch').classList.remove('visible');
      });
    }

    lastPhase = job.phase;
    currentJobPhase = job.phase; // Track current job state
  }

  async function processAnimQueue(total) {
    if (isAnimating || animQueue.length === 0) return;
    isAnimating = true;
    while (animQueue.length > 0) {
      const profile = animQueue.shift();
      animationCounter++; // Increment animation counter
      const score = profile.analysis?.relevance_score || 0;
      showSlideCard(profile, animationCounter - 1);
      await new Promise(r => setTimeout(r, 400));
      updateSlideScore(score);
      document.getElementById('scoringCounter').textContent = `${animationCounter} / ${total}`;
      await new Promise(r => setTimeout(r, 1200));
      await slideOut();
    }
    isAnimating = false;
  }

  // â”€â”€â”€ SELECTION INTERFACE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderSelection(withEmail, withoutEmail) {
    document.getElementById('selectionSection').classList.add('visible');
    document.getElementById('emailBadge').textContent = withEmail.length;
    document.getElementById('noEmailBadge').textContent = withoutEmail.length;
    document.getElementById('emailList').innerHTML = withEmail.map((p, i) => profileSelectItem(p, 'e' + i)).join('');
    document.getElementById('noEmailList').innerHTML = withoutEmail.map((p, i) => profileSelectItem(p, 'n' + i)).join('');
    updateSelectedCount();
  }
  function profileSelectItem(p, id) {
    return `<div class="select-item" onclick="this.querySelector('input').click()">
      <input type="checkbox" id="sel_${id}" data-url="${esc(p.linkedin_url)}" onchange="updateSelectedCount()" onclick="event.stopPropagation()">
      <div class="select-item-info">
        <div class="select-item-name">${esc(p.name)}</div>
        <div class="select-item-detail">${esc(p.headline)} ${p.company ? 'â€¢ ' + esc(p.company) : ''}</div>
        ${p.email ? `<div class="select-item-email">${esc(p.email)}</div>` : ''}
      </div>
    </div>`;
  }
  function updateSelectedCount() {
    const checked = document.querySelectorAll('#selectionSection input[type="checkbox"]:checked');
    const count = checked.length;
    document.getElementById('selectedCount').textContent = `${count} selected`;

    // Update floating Deep Search button
    const deepBtn = document.getElementById('deepSearchBtn');
    const deepBtnText = document.getElementById('deepSearchBtnText');
    deepBtnText.textContent = `Deep Search (${count})`;
    deepBtn.disabled = count === 0;
    if (count > 25) deepBtnText.textContent += ' â€” max 25!';
  }
  function toggleSelectAll() {
    const boxes = document.querySelectorAll('#selectionSection input[type="checkbox"]');
    const allChecked = Array.from(boxes).every(b => b.checked);
    boxes.forEach(b => b.checked = !allChecked);
    updateSelectedCount();
  }

  async function startPostScraping() {
    const checked = document.querySelectorAll('#selectionSection input[type="checkbox"]:checked');
    const urls = Array.from(checked).map(c => c.dataset.url).slice(0, 25);
    if (!urls.length) return;

    document.getElementById('selectionSection').classList.remove('visible');
    document.getElementById('floatingDeepSearch').classList.remove('visible');
    lastPhase = '';
    lastAnalyzedCount = 0;
    animQueue = [];
    isAnimating = false;
    animationCounter = 0; // Reset animation counter for new Phase 2

    showStatus('Starting post scraping...', POST_MESSAGES[0]);
    startMessages(POST_MESSAGES);
    setPipeline(4);

    try {
      await fetch(`/api/search/${jobId}/select`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({linkedin_urls: urls}),
      });
      startPolling();
    } catch (e) {
      hideStatus();
      showError('Failed to start post scraping.');
    }
  }

  function exportCSV(type) {
    if (!jobId) return;
    window.location.href = `/api/export/${type}/${jobId}`;
  }

  // â”€â”€â”€ FINAL RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let analyzedProfiles = [];

  function renderResults(profiles) {
    analyzedProfiles = profiles; // store globally for post panel lookup
    document.getElementById('resultsSection').classList.add('visible');
    document.getElementById('resultsTitle').textContent = `Analysis Results (${profiles.length})`;
    const list = document.getElementById('resultsList');
    list.innerHTML = '';

    profiles.forEach((p, i) => {
      const a = p.analysis || {};
      const score = a.relevance_score || 0;
      const scoreClass = score >= 70 ? 'high' : score >= 40 ? 'mid' : 'low';
      const actClass = (a.activity_level || '').toLowerCase();
      const topics = (a.key_topics || []).map(t => `<span class="chip">${esc(t)}</span>`).join('');
      const interests = (a.areas_of_interest || []).map(t => `<span class="chip interest">${esc(t)}</span>`).join('');
      const postCount = (p.posts || []).length;
      const color = AVATAR_COLORS[i % AVATAR_COLORS.length];
      const initials = getInitials(p.name);
      const avatarHtml = p.photo
        ? `<img src="${esc(p.photo)}" alt="${esc(p.name)}" onerror="this.parentElement.innerHTML='${initials}';this.parentElement.style.background='${color}'">`
        : initials;

      // Stats row with separators
      const statParts = [];
      if (p.connections) statParts.push(`${p.connections.toLocaleString()} connections`);
      if (p.followers) statParts.push(`${p.followers.toLocaleString()} followers`);
      const statsHtml = statParts.map((s, idx) =>
        (idx > 0 ? '<span class="rc-stat-sep">Â·</span>' : '') + `<span>${s}</span>`
      ).join('') + (p.is_hiring ? '<span class="rc-stat-sep">Â·</span><span class="rc-hiring">HIRING</span>' : '');

      const card = document.createElement('div');
      card.className = 'result-card';
      card.style.animationDelay = (i * 0.06) + 's';
      card.innerHTML = `
        <div class="rc-head">
          <div class="rc-avatar" style="${p.photo ? '' : 'background:' + color}">${avatarHtml}</div>
          <div class="rc-info">
            <div class="result-name" onclick="openPostPanel(${i})">${esc(p.name)}</div>
            ${postCount > 0 ? `<div class="result-posts-hint">&#128196; ${postCount} posts &mdash; click name to explore</div>` : ''}
            <div class="rc-headline">${esc(p.headline)}</div>
            <div class="rc-location">${[p.company, p.location_text].filter(Boolean).map(esc).join(' &bull; ')}</div>
            ${statsHtml ? `<div class="rc-stats">${statsHtml}</div>` : ''}
          </div>
          <div class="rc-score-col">
            <div class="rsb-label">Relevance <i class="tip-icon" tabindex="0">?<span class="tooltip">How well this person matches your search query (0â€“100).<br><br>ðŸŸ¢ 70â€“100 Strong match<br>ðŸŸ¡ 40â€“69 Partial match<br>âšª 0â€“39 Weak match</span></i></div>
            <div class="rc-score-ring ${scoreClass}">${score}</div>
            <div class="rsb-label" style="margin-top:4px">Activity <i class="tip-icon" tabindex="0">?<span class="tooltip">How frequently this person posts on LinkedIn.<br><br>ðŸŸ¢ High â€” posts weekly or more<br>ðŸŸ¡ Medium â€” posts monthly<br>âšª Low â€” rarely posts<br>ðŸ”´ Inactive â€” no recent posts</span></i></div>
            <div class="result-activity ${actClass}">${esc(a.activity_level || 'Unknown')}</div>
          </div>
        </div>
        <div class="rc-sep"></div>
        ${(p.email || p.linkedin_url) ? `
        <div class="rc-contact">
          ${p.email ? `<div class="rc-email-btn" data-email="${esc(p.email)}">&#9993; ${esc(p.email)} <span class="rc-copy-hint">&middot; copy</span></div>` : ''}
          ${p.linkedin_url ? `<a class="rc-linkedin-btn" href="${esc(p.linkedin_url)}" target="_blank" rel="noopener"><svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6zM2 9h4v12H2zm2-3a2 2 0 100-4 2 2 0 000 4z"/></svg> View Profile</a>` : ''}
          ${p.email ? `<button class="rc-outreach-btn" onclick="draftOutreachEmail(${i}, this)"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> Outreach</button>` : ''}
          <button class="rc-chat-btn" onclick="openChat(${i}, this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6z"/></svg> Ask AI</button>
        </div>
        <div class="rc-sep"></div>` : ''}
        <div class="rc-body">
          ${topics || interests ? `<div class="rc-chips">${topics}${interests}</div>` : ''}
          ${(a.recent_activity_summary || a.engagement_metrics) ? `
          <div class="rc-insight-grid">
            ${a.recent_activity_summary ? `<div class="rc-insight-box"><div class="rc-insight-title">&#128195; Activity</div><div class="rc-insight-text">${esc(a.recent_activity_summary)}</div></div>` : ''}
            ${a.engagement_metrics ? `<div class="rc-insight-box"><div class="rc-insight-title">&#128200; Engagement</div><div class="rc-insight-text">${esc(a.engagement_metrics)}</div></div>` : ''}
          </div>` : ''}
          ${a.recommendation ? `<div class="rc-recommendation">${esc(a.recommendation)}</div>` : ''}
        </div>
      `;
      list.appendChild(card);
    });
  }

  // â”€â”€â”€ OUTREACH EMAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function draftOutreachEmail(index, btn) {
    const p = analyzedProfiles[index];
    if (!p || !p.email || !jobId) return;

    const origHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<svg class="spin" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="9"/><path d="M12 3a9 9 0 019 9"/></svg> Drafting...`;

    try {
      const res = await fetch(`/api/draft-email/${jobId || 'local'}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        // Send the full profile so the backend can work even after a Lambda cold start
        body: JSON.stringify({linkedin_url: p.linkedin_url, profile_data: p}),
      });

      if (!res.ok) {
        const err = await res.json();
        alert(`Could not draft email: ${err.detail || 'Unknown error'}`);
        return;
      }

      const {to, subject, body} = await res.json();
      const mailto = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = mailto;

      // Brief success flash
      btn.innerHTML = `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Done!`;
      btn.style.background = '#e8f8f5';
      setTimeout(() => { btn.innerHTML = origHtml; btn.style.background = ''; btn.disabled = false; }, 2000);

    } catch (e) {
      alert('Failed to generate email draft. Please try again.');
      btn.innerHTML = origHtml;
      btn.disabled = false;
    }
  }

  // â”€â”€â”€ PROFILE CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let chatCurrentProfile = null;
  let chatHistory = [];

  function renderMarkdown(text) {
    return text
      .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\n\n/g, '<br><br>')
      .replace(/\n/g, '<br>');
  }

  function _resetChatMessages(profile) {
    const msgs = document.getElementById('chatMessages');
    const postCount = (profile.posts || []).length;
    msgs.innerHTML = `
      <div class="chat-welcome">
        <div class="chat-welcome-icon">&#128172;</div>
        <div class="chat-welcome-text">Hi! I have full access to <strong>${esc(profile.name)}'s</strong> LinkedIn profile, work history, skills${postCount > 0 ? ', and ' + postCount + ' recent posts' : ''}. Ask me anything.</div>
        <div class="chat-suggestions">
          <div class="chat-sug-label">Try asking</div>
          <div class="chat-sug-chips">
            <button class="sug-chip" onclick="useSuggestion(this)">Summarise their career</button>
            <button class="sug-chip" onclick="useSuggestion(this)">What do they post about?</button>
            <button class="sug-chip" onclick="useSuggestion(this)">What are their key skills?</button>
            <button class="sug-chip" onclick="useSuggestion(this)">Are they a strong lead?</button>
          </div>
        </div>
      </div>`;
  }

  function openChat(index, btn) {
    const p = analyzedProfiles[index];
    if (!p) return;

    // Button spinner feedback
    if (btn) {
      btn.disabled = true;
      const orig = btn.innerHTML;
      btn.innerHTML = `<svg class="spin" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="9"/><path d="M12 3a9 9 0 019 9"/></svg> Preparing...`;
      setTimeout(() => { btn.innerHTML = orig; btn.disabled = false; }, 450);
    }

    chatCurrentProfile = p;
    chatHistory = [];

    // Set header
    const color = AVATAR_COLORS[index % AVATAR_COLORS.length];
    const av = document.getElementById('chatHeaderAvatar');
    if (p.photo) {
      av.innerHTML = `<img src="${esc(p.photo)}" alt="" onerror="this.parentElement.innerHTML='${getInitials(p.name)}';this.parentElement.style.background='${color}'">`;
      av.style.background = '';
    } else {
      av.innerHTML = getInitials(p.name);
      av.style.background = color;
    }
    document.getElementById('chatHeaderName').textContent = p.name || '';

    _resetChatMessages(p);

    setTimeout(() => {
      document.getElementById('chatModal').classList.add('open');
      document.body.style.overflow = 'hidden';
      setTimeout(() => document.getElementById('chatInput').focus(), 80);
    }, btn ? 420 : 0);
  }

  function closeChat() {
    document.getElementById('chatModal').classList.remove('open');
    document.body.style.overflow = '';
    chatCurrentProfile = null;
    chatHistory = [];
  }

  function useSuggestion(btn) {
    document.getElementById('chatInput').value = btn.textContent;
    sendChatMessage();
  }

  function appendChatMsg(role, content) {
    const msgs = document.getElementById('chatMessages');
    // Remove welcome block on first real message
    const welcome = msgs.querySelector('.chat-welcome');
    if (welcome) welcome.remove();

    const div = document.createElement('div');
    div.className = `chat-msg ${role}`;
    const html = role === 'assistant' ? renderMarkdown(content) : esc(content).replace(/\n/g, '<br>');
    div.innerHTML = `<div class="chat-bubble">${html}</div>`;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function showTyping() {
    const msgs = document.getElementById('chatMessages');
    const d = document.createElement('div');
    d.className = 'chat-typing-wrap'; d.id = 'chatTyping';
    d.innerHTML = '<div class="chat-typing"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
    msgs.appendChild(d);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function hideTyping() {
    const t = document.getElementById('chatTyping');
    if (t) t.remove();
  }

  async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message || !chatCurrentProfile || !jobId) return;

    const btn = document.getElementById('chatSendBtn');
    input.value = '';
    input.style.height = '';
    btn.disabled = true;

    appendChatMsg('user', message);
    showTyping();

    try {
      const res = await fetch(`/api/chat/${jobId || 'local'}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        // Send the full profile so the backend can work even after a Lambda cold start
        body: JSON.stringify({
          linkedin_url: chatCurrentProfile.linkedin_url,
          message,
          history: chatHistory,
          profile_data: chatCurrentProfile,
        }),
      });
      const data = await res.json();
      hideTyping();

      const reply = res.ok ? (data.reply || '') : `Sorry, something went wrong. ${data.detail || ''}`;
      appendChatMsg('assistant', reply);

      if (res.ok) {
        chatHistory.push({role: 'user', content: message});
        chatHistory.push({role: 'assistant', content: reply});
      }
    } catch (e) {
      hideTyping();
      appendChatMsg('assistant', 'Sorry, the request failed. Please try again.');
    }

    btn.disabled = false;
    input.focus();
  }

  // Auto-resize chat textarea
  document.addEventListener('input', e => {
    if (e.target.id === 'chatInput') {
      e.target.style.height = 'auto';
      e.target.style.height = Math.min(e.target.scrollHeight, 100) + 'px';
    }
  });

  // â”€â”€â”€ POST PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let ppCurrentProfile = null;
  let ppCurrentTab = 'relevant';

  function openPostPanel(index) {
    const p = analyzedProfiles[index];
    if (!p) return;
    ppCurrentProfile = p;

    const color = AVATAR_COLORS[index % AVATAR_COLORS.length];
    const av = document.getElementById('ppAvatar');
    av.style.background = color;
    av.textContent = getInitials(p.name);
    document.getElementById('ppName').textContent = p.name || '';
    document.getElementById('ppHeadline').textContent = p.headline || p.company || '';

    document.getElementById('postPanel').classList.add('open');
    document.body.style.overflow = 'hidden';
    switchPPTab('relevant');
  }

  function closePostPanel() {
    document.getElementById('postPanel').classList.remove('open');
    document.body.style.overflow = '';
  }

  function switchPPTab(tab) {
    ppCurrentTab = tab;
    document.getElementById('ppTabRelevant').classList.toggle('active', tab === 'relevant');
    document.getElementById('ppTabRecent').classList.toggle('active', tab === 'recent');
    renderPPPosts(tab);
  }

  function ppQueryTerms() {
    return document.getElementById('searchQuery').value.trim()
      .replace(/["()]/g, ' ')
      .replace(/\b(AND|OR|NOT)\b/gi, ' ')
      .split(/\s+/)
      .filter(t => t.length > 1)
      .map(t => t.toLowerCase());
  }

  function ppScorePost(text, terms) {
    const t = (text || '').toLowerCase();
    return terms.reduce((s, term) => {
      const re = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      return s + (t.match(re) || []).length;
    }, 0);
  }

  function renderPPPosts(tab) {
    const posts = (ppCurrentProfile && ppCurrentProfile.posts) || [];
    const body = document.getElementById('ppBody');
    if (!posts.length) {
      body.innerHTML = '<div class="pp-empty">No posts were scraped for this profile.</div>';
      return;
    }
    let list;
    if (tab === 'relevant') {
      const terms = ppQueryTerms();
      list = [...posts]
        .map(p => ({ ...p, _score: ppScorePost(p.text, terms) }))
        .sort((a, b) => b._score - a._score)
        .slice(0, 15);
    } else {
      list = [...posts].slice(0, 10); // already ordered newest-first by scraper
    }
    body.innerHTML = list.map(p => ppPostCard(p, tab === 'relevant')).join('');
  }

  function ppPostCard(post, showScore) {
    const mType = post.media_type || '';
    const mImages = post.media_images || [];
    const mThumb = post.media_thumbnail || '';
    const mUrl = post.media_url || '';

    // Best thumbnail source: first image > video thumbnail > main URL (if image type)
    const imgSrc = mImages[0] || mThumb || (mType === 'image' ? mUrl : '');

    let mediaHtml = '';
    if (imgSrc) {
      const extraCount = mImages.length > 1 ? `<span class="pc-img-count">+${mImages.length - 1} more</span>` : '';
      const videoBadge = mType === 'video' ? '<span class="pc-overlay-badge">&#9654; VIDEO</span>' : '';
      mediaHtml = `<div class="pc-thumb-wrap">
        <img class="pc-thumb" src="${esc(imgSrc)}" alt="" onerror="this.closest('.pc-thumb-wrap').remove()">
        ${videoBadge}${extraCount}
      </div>`;
    } else if (mType === 'video') {
      // Video exists but no thumbnail available
      mediaHtml = `<div class="pc-placeholder">
        <span class="pc-placeholder-icon">&#127909;</span>
        <span class="pc-placeholder-label">Video</span>
      </div>`;
    } else if (mType === 'document') {
      mediaHtml = `<div class="pc-doc-banner">
        <span class="pc-doc-icon">&#128196;</span>
        <span class="pc-doc-text">Document attached</span>
      </div>`;
    }

    const score = post._score || 0;
    const scoreBadge = (showScore && score > 0)
      ? `<span class="pc-score">&#9733; ${score} match${score !== 1 ? 'es' : ''}<span class="tooltip" style="bottom:calc(100% + 6px);left:0;transform:none;width:220px">How many times your search query keywords appear in this post. More matches = more relevant to what you searched for.</span></span><br>`
      : '';
    const dateStr = esc(post.relative || (post.date ? post.date.split(' ')[0] : '') || '');
    const postUrl = post.post_url || '';

    return `<div class="post-card">
      ${mediaHtml}
      <div class="pc-body">
        ${scoreBadge}
        <div class="pc-text">${esc(post.text || '')}</div>
        <div class="pc-footer">
          <span class="pc-date">${dateStr}</span>
          <span class="pc-stats">&#128077; ${(post.likes||0).toLocaleString()} &nbsp;&#128172; ${(post.comments||0).toLocaleString()} &nbsp;&#128257; ${(post.reposts||0).toLocaleString()}</span>
          ${postUrl ? `<a class="pc-link" href="${esc(postUrl)}" target="_blank" rel="noopener">View &#8599;</a>` : ''}
        </div>
      </div>
    </div>`;
  }

  // Close panel on Escape key
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closePostPanel(); });

  // â”€â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.classList.add('visible');
  }
  function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  function copyToClipboard(text) {
    if (navigator.clipboard && window.isSecureContext) return navigator.clipboard.writeText(text);
    const ta = document.createElement('textarea'); ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px';
    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    return Promise.resolve();
  }

  // Email copy delegation
  document.addEventListener('click', (e) => {
    const el = e.target.closest('.rc-email-btn');
    if (!el) return;
    e.preventDefault();
    const email = el.dataset.email;
    if (!email) return;
    copyToClipboard(email).then(() => {
      const orig = el.innerHTML;
      el.innerHTML = '&#10003; Copied!';
      el.style.background = '#e8f8f5';
      el.style.color = '#00b894';
      el.style.borderColor = '#b2ead8';
      setTimeout(() => { el.innerHTML = orig; el.style.background = ''; el.style.color = ''; el.style.borderColor = ''; }, 1600);
    });
  });

  // On page load: reconnect to an in-progress job OR restore completed results
  (async function onPageLoad() {
    const savedJobId    = localStorage.getItem('leadIntelJobId');
    const savedQuery    = localStorage.getItem('leadIntelSearchQuery');
    const btn           = document.getElementById('searchBtn');

    // Restore selection data so step-click navigation works even after refresh
    try {
      const raw = localStorage.getItem('leadIntelSelectionData');
      if (raw) selectionData = JSON.parse(raw);
    } catch(e) {}

    if (savedJobId) {
      try {
        const res = await fetch(`/api/search/progress/${savedJobId}`);
        if (!res.ok) throw new Error('not found');
        const job = await res.json();
        jobId = savedJobId;
        if (savedQuery) document.getElementById('searchQuery').value = savedQuery;
        document.getElementById('pipeline').classList.add('visible');

        if (job.phase === 'complete') {
          localStorage.removeItem('leadIntelJobId');
          setPipeline(6, true);
          renderResults(job.analyzed_profiles);
          return;
        }

        if (job.phase === 'error') {
          localStorage.removeItem('leadIntelJobId');
          showError(job.error);
          btn.style.display = '';
          document.getElementById('floatingDeepSearch').classList.remove('visible');
          return;
        }

        if (job.phase === 'awaiting_selection') {
          setPipeline(3);
          renderSelection(job.profiles_with_email, job.profiles_without_email);

          // Hide search button, show floating Deep Search button
          btn.style.display = 'none';
          document.getElementById('floatingDeepSearch').classList.add('visible');

          return;
        }

        // Job is still actively running (scraping / filtering / scraping_posts / analyzing)
        btn.disabled = true;
        btn.textContent = 'Searching...';

        if (job.phase === 'scraping') {
          setPipeline(1);
          showStatus('Searching LinkedIn for matching profiles...', SCRAPING_MESSAGES[0]);
          startMessages(SCRAPING_MESSAGES);
        } else if (job.phase === 'filtering') {
          setPipeline(2);
          showStatus(`Found ${job.profiles_found} profiles. Applying filters...`, '');
        } else if (job.phase === 'scraping_posts') {
          setPipeline(4);
          showStatus(`Scraping posts: ${job.posts_scraped} / ${job.posts_total}`, POST_MESSAGES[0]);
          startMessages(POST_MESSAGES);
          document.getElementById('floatingDeepSearch').classList.remove('visible');
        } else if (job.phase === 'analyzing') {
          document.getElementById('floatingDeepSearch').classList.remove('visible');
          setPipeline(5);
          document.getElementById('scoringStage').classList.add('visible');
          // Skip animation for already-analyzed profiles â€” just set the counter
          lastAnalyzedCount = job.analyzed_profiles.length;
          animationCounter = job.analyzed_profiles.length; // Set animation counter to current progress
          document.getElementById('scoringCounter').textContent =
            `${job.analyzed_profiles.length} / ${job.analyzed_total}`;
          showStatus('Analyzing profiles with AI...', 'Resuming analysis...');
        }

        lastPhase = job.phase;
        currentJobPhase = job.phase; // Track job phase on page load
        startPolling();
        return;

      } catch (e) {
        // Job not found on server (server restarted) â€” fall through to cache
        localStorage.removeItem('leadIntelJobId');
      }
    }

    // No active job â€” restore completed results from cache
    try {
      const raw = localStorage.getItem('leadIntelCache');
      if (!raw) return;
      const cache = JSON.parse(raw);
      if (!cache.analyzed || !cache.analyzed.length) return;
      if (cache.searchQuery) document.getElementById('searchQuery').value = cache.searchQuery;
      if (cache.jobId) jobId = cache.jobId;
      document.getElementById('pipeline').classList.add('visible');
      setPipeline(6, true);
      renderResults(cache.analyzed);
    } catch (e) {}
  })();
</script>
</body>
</html>
